### [â¤º Back to Table of Contents](/README.md#divergence-framework-documentation)

# ORM
Divergence uses a typical ActiveRecord pattern for it's models.

## Model Architecture

#### Extend `Divergence\Models\ActiveRecord` to use no default fields.
#### Extend `Divergence\Models\Model` to use these default fields.
| Type | Field | Description |
-------|-------|-------------|
|`int` | `ID` | The primary key. |
| `string` | `Class` | Fully qualified PHP namespaced class. |
| `timestamp` | `Created` | Time when the object is created in the database. |
| `int` | `Creator` | Reserved for use with authentication system. |


#### Traits
| Trait | Description |
|-------| ---- |
| `Divergence\Models\Relations` | Lets you build relationships between models. |
| `Divergence\Models\Versioning` | Automatically tracks history of all models |
---
Classes that use ActiveRecord may optionally use traits to enable relationship features and versioning features respectively.

#### Object Oriented Architecture
ActiveRecord will merge `public static $fields` and  `public static $relationships` at run-time giving priority to the child. You can override fields in the child class that have already been set by a parent class.

A child class may choose to unset a relationship or field simply by setting the config to null. A child class may also use a different type for the same database field name.

Overrides must use the key for the field configuration.

You **must** define these seven configurables. (Don't worry most you can copy and paste.)

#### Subclassing
 ```php
    public static $rootClass = __CLASS__;
    public static $defaultClass = __CLASS__;
    public static $subClasses = [__CLASS__];
```
In the event that you have subclasses you can define them here. By default just use the above configuration. You'll want to override `$rootClass` and `$defaultClass` if necessary for yourself.

#### Table Name & Nouns
```php
    public static $tableName = 'table';
    public static $singularNoun = 'table';
    public static $pluralNoun = 'tables';
```
Table name is for the database table.
Singular noun and plural noun are mostly used by `RecordsRequestHandler` to load the right template so think of those as template filenames.

#### Fields
ActiveRecord merges this configurable up the class stack giving children priority. Any defined $fields are usable as `$Model->$fieldName`.
```php
    public static $fields = [
        'Tag',
        'Slug',
    ];
```

Want to get rid of a field from a parent? No problem.
```php
    public static $fields = [
        'Tag',
        'Slug',
        'Creator' => null, // this will not be usable as a field in this model
    ];
```

#### About Default Field Configs
By default if you just have a string that will be treated as the name of the field for the model. By default it's treated as a string by PHP and a varchar(255) by the database if allowed to be automatically generated by the framework. There are no default validators so the database will truncate any values above 255 characters.

#### Automatically Create Tables
If you try to use a Model and the database responds with the error for "table not found" then it will will automatically build you the SQL to create the table, run it, and rerun the original query without throwing an error to the user.

You can disable this behaviour by setting `public static $autoCreateTable` to false in your model.


## Making a Basic Model
Here's an example of a minimum Model
```php
<?php
namespace yourApp\Models;

class Tag extends \Divergence\Models\Model
{
    
    // support subclassing
    public static $rootClass = __CLASS__;
    public static $defaultClass = __CLASS__;
    public static $subClasses = [__CLASS__];


    // ActiveRecord configuration
    public static $tableName = 'tags';
    public static $singularNoun = 'tag';
    public static $pluralNoun = 'tags';
    
    public static $fields = [
        'Tag',
    ];
```
We get these fields from `\Divergence\Models\Model` as defaults.
```php
    public static $fields = [
        'ID' => [
            'type' => 'integer',
            'autoincrement' => true,
            'unsigned' => true,
        ],
        'Class' => [
            'type' => 'enum',
            'notnull' => true,
            'values' => [],
        ],
        'Created' => [
            'type' => 'timestamp',
            'default' => 'CURRENT_TIMESTAMP',
        ],
        'CreatorID' => [
            'type' => 'integer',
            'notnull' => false,
        ],
    ];
```

## Create, Update, and Delete
Divergence ActiveRecord is super simple and easy making use of native PHP architecture whenever possible.
### Creating
---
Example without defaults
```php
$Tag = new Tag();
echo $Tag->Name; // prints null
$Tag->Name = 'Divergence';
echo $Tag->Name; // prints Divergence
```

Example with record instantiation via construct
```php
$Tag = new Tag([
    'Name'  => 'Divergence',
]);
echo $Tag->Name; // prints Divergence
```

Example with record instantiation via create method
```php
$Tag = Tag::create([
    'Name'  => 'Divergence',
]);
echo $Tag->Name; // prints Divergence
```

Example with record instantiation via create method and save to database
```php
$Tag = Tag::create([
    'Name'  => 'Divergence',
],true); // save directly to database right away
echo $Tag->Name; // prints Divergence
echo $Tag->ID; // prints ID assigned by the database auto increment
```

Another save example
```php
$Tag = new Tag();
$Tag->Name = 'Divergence';
echo $Tag->ID; // prints null
$Tag->save();
echo $Tag->ID; // prints ID assigned by the database auto increment
``` 

### Update
---
```php
$Tag = Tag::getByID(1);
echo $Tag->ID; // prints 1
$Tag->Name = 'Divergence';
$Tag->save();
```

Get By Field
```php
$Tag = Tag::getByField('ID',1);
echo $Tag->ID; // prints 1
$Tag->Name = 'Divergence';
$Tag->save();
```

### Delete
---
```php
$Tag = Tag::getByID(1);
echo $Tag->ID; // prints 1
$Tag->destroy(); // record still in variable
```

or statically
```php
Tag::delete(1); // returns true if DB::affectedRows > 0
```

## Versioning
Your model must be defined with a `use Versioning` in it's definition.
```php
<?php
namespace Divergence\Tests\MockSite\Models;

use \Divergence\Models\Model;
use \Divergence\Models\Versioning;

class Tag extends Model
{
    use Versioning;
```

#### Configurables
You **must** provide these settings to use versioning.
```php
    // versioning
    static public $historyTable = 'test_history';
    static public $createRevisionOnDestroy = true;
    static public $createRevisionOnSave = true;
```
If you did not create your tables yet a versioned model will have it's history table automatically created.

If you add versioning support after your main table is already in use you must use the SQL class to build yourself a table creation query.

#### Trait `\Divergence\Models\Versioning` provides these fields.

##### Definition
```php
    public static $versioningFields = [
        'RevisionID' => [
            'columnName' => 'RevisionID',
            'type' => 'integer',
            'unsigned' => true,
            'notnull' => false,
        ],
    ];
```

#### Trait `\Divergence\Models\Versioning` provides these methods.
| Method | Purpose |
| --- | ---|
| getRevisionsByID | Returns an array of versions of a model by ID and $options config. |
| getRevisions | Returns an array of versions of a model by $options config. |
---

#### Trait `\Divergence\Models\Versioning` provides these relationships.
| Relationship | Type | Purpose |
| --- | --- | --- |
| History | History | Pulls old versions of this Model |

##### Definition
```php
    'History' => [
        'type' => 'history',
        'order' => ['RevisionID' => 'DESC'],
    ],
```

##### Example - *Must use the Relational trait*
```php
$Model->getByID(1);
$Model->History; // array of revisions where ID == 1 ordered by RevisionID

($Model->History === $Model->History[0]->History) // returns true
```

## Relationships

## Supported Field Types

| Field Type | Database Type | Default Options |
| --- | --- | --- |
| int | int | notnull = false, unsigned = true, required = false, $default = null|
| string | varchar (255) | notnull = false, required = false, $default = null|
| float | float | notnull = false, unsigned = true, required = false, $default = null|
| enum | enum | values = [], notnull = false, required = false, $default = null|
| clob | text | notnull = false, required = false, $default = null |
| boolean | int (1) | notnull = false, unsigned = true, required = false, $default = null |
| password | varchar (255) | notnull = false, unsigned = true, required = false, $default = null |
| timestamp | timestamp | notnull = false, unsigned = true, required = false, $default = null |
| date | date | notnull = false, unsigned = true, required = false, $default = null |
| serialized | text | notnull = false, unsigned = true, required = false, $default = null |
| set | set | notnull = false, unsigned = true, required = false, $default = null |
| list | list | notnull = false, unsigned = true, required = false, $default = null |


## Canary Model - An Example Utilizing Every Field Type
```php
<?php
namespace App\Models;

use Divergence\Models\Relations;
use Divergence\Models\Versioning;

/*
 *  The purpose of this Model is to provide an example of every field type
 *  hopefully in every possible configuration.
 *
 */
class Canary extends \Divergence\Models\Model
{
    use Versioning, Relations;
    
    // support subclassing
    public static $rootClass = __CLASS__;
    public static $defaultClass = __CLASS__;
    public static $subClasses = [__CLASS__];


    // ActiveRecord configuration
    public static $tableName = 'canaries';
    public static $singularNoun = 'canary';
    public static $pluralNoun = 'canaries';
    
    // versioning
    public static $historyTable = 'canaries_history';
    public static $createRevisionOnDestroy = true;
    public static $createRevisionOnSave = true;

    public static $fields = [
        'ContextID' => [
            'type' => 'int',
            'default' => 7,
        ],
        'ContextClass' => [
            'type' => 'enum',
            'values' => [Tag::class],
            'default' => Tag::class,
        ],
        'DNA' => [
            'type' => 'clob',
            'notnull' => true,
        ],
        'Name' => [
            'type' => 'string',
            'required' => true,
            'notnull' => true,
        ],
        'Handle' => [
            'type' => 'string',
            'blankisnull' => true,
            'notnull' => false,
        ],
        'isAlive' => [
            'type' => 'boolean',
            'default' => true,
        ],
        'DNAHash' => [
            'type' => 'password',
        ],
        'StatusCheckedLast' => [
            'type' => 'timestamp',
            'notnull' => false,
        ],
        'SerializedData' => [
            'type' => 'serialized',
        ],
        'Colors' => [
            'type' => 'set',
            'values' => [
                "red",
                "pink",
                "purple",
                "deep-purple",
                "indigo",
                "blue",
                "light-blue",
                "cyan",
                "teal",
                "green",
                "light-green",
                "lime",
                "yellow",
                "amber",
                "orange",
                "deep-orange",
                "brown",
                "grey",
                "blue-grey",
            ],
        ],
        'EyeColors' => [
            'type' => 'list',
            'delimiter' => '|',
        ],
        'Height' => [
            'type' => 'float',
        ],
        'LongestFlightTime' => [
            'type' => 'int',
            'notnull' => false,
        ],
        'HighestRecordedAltitude' => [
            'type' => 'uint',
        ],
        'ObservationCount' => [
            'type' => 'integer',
            'notnull' => true,
        ],
        'DateOfBirth' => [
            'type' => 'date',
        ],
    ];
}
```

## Validation

## Event Binding

## Advanced Techniques